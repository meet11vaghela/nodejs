<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User CRUD</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f4f4f4; }
    button { margin: 2px; }
  </style>
</head>
<body>
  <h1>User CRUD (JWT Protected)</h1>

  <section id="authSection">
    <h2>Authentication</h2>
    <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start;">
      <form id="registerForm">
        <h3>Register</h3>
        <input type="text" id="reg_name" placeholder="Name" required>
        <input type="email" id="reg_email" placeholder="Email" required>
        <input type="password" id="reg_password" placeholder="Password" required>
        <input type="number" id="reg_age" placeholder="Age">
        <button type="submit">Register</button>
      </form>

      <form id="loginForm">
        <h3>Login</h3>
        <input type="email" id="login_email" placeholder="Email" required>
        <input type="password" id="login_password" placeholder="Password" required>
        <button type="submit">Login</button>
      </form>

      <div>
        <h3>Session</h3>
        <div id="me"></div>
        <button id="logoutBtn" type="button">Logout</button>
      </div>
    </div>
    <div id="authMsg" style="margin-top:8px;color:#666;"></div>
  </section>

  <form id="userForm" style="display:none;">
    <input type="hidden" id="userId">
    <input type="text" id="name" placeholder="Name" required>
    <input type="email" id="email" placeholder="Email" required>
    <input type="number" id="age" placeholder="Age">
    <button type="submit">Save</button>
  </form>

  <table id="userTableWrap" style="display:none;">
    <thead>
      <tr><th>Name</th><th>Email</th><th>Age</th><th>Actions</th></tr>
    </thead>
    <tbody id="userTable"></tbody>
  </table>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    const apiBase = '/api/users';
    const authBase = '/api/auth';

    function getToken() { return localStorage.getItem('token') || ''; }
    function setToken(t) { if (t) { localStorage.setItem('token', t); } }
    function clearToken() { localStorage.removeItem('token'); }

    function authHeaders() {
      const t = getToken();
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    }

    function setAuthedUI(isAuthed) {
      document.getElementById('userForm').style.display = isAuthed ? '' : 'none';
      document.getElementById('userTableWrap').style.display = isAuthed ? '' : 'none';
    }

    function renderUsers(users) {
      const rows = users.map(function(u) {
        const safeName = String(u.name || '').replace(/"/g, '&quot;');
        const safeEmail = String(u.email || '').replace(/"/g, '&quot;');
        const age = (u.age === undefined || u.age === null) ? '' : u.age;
        return (
          `\n        <tr>\n          <td>${safeName}</td>\n          <td>${safeEmail}</td>\n          <td>${age}</td>\n          <td>\n            <button onclick="editUser('${u._id}','${safeName}','${safeEmail}','${age}')">Edit</button>\n            <button onclick="deleteUser('${u._id}')">Delete</button>\n          </td>\n        </tr>`
        );
      }).join('');
      document.getElementById('userTable').innerHTML = rows;
    }

    function fetchUsers() {
      $.ajax({ url: apiBase, headers: authHeaders() })
        .done(function(res) {
          const users = Array.isArray(res) ? res : (res && res.data) ? res.data : [];
          renderUsers(users);
        })
        .fail(function(err) {
          const status = err && err.status;
          if (status === 401) {
            $('#authMsg').text('Please login to view users.');
            setAuthedUI(false);
          }
          renderUsers([]);
        });
    }

    window.deleteUser = function(id) {
      $.ajax({ url: apiBase + '/' + id, type: 'DELETE', headers: authHeaders() })
        .always(fetchUsers);
    };

    window.editUser = function(id, name, email, age) {
      $('#userId').val(id);
      $('#name').val(name);
      $('#email').val(email);
      $('#age').val(age);
    };

    $('#userForm').on('submit', function(e) {
      e.preventDefault();
      const id = $('#userId').val();
      const user = {
        name: $('#name').val(),
        email: $('#email').val(),
        age: $('#age').val() ? Number($('#age').val()) : undefined
      };

      const options = {
        url: id ? (apiBase + '/' + id) : apiBase,
        type: id ? 'PUT' : 'POST',
        data: JSON.stringify(user),
        contentType: 'application/json',
        headers: authHeaders()
      };

      $.ajax(options)
        .always(function() {
          (document.getElementById('userForm')).reset();
          $('#userId').val('');
          fetchUsers();
        });
    });

    // Register
    $('#registerForm').on('submit', function(e) {
      e.preventDefault();
      const payload = {
        name: $('#reg_name').val(),
        email: $('#reg_email').val(),
        password: $('#reg_password').val(),
        age: $('#reg_age').val() ? Number($('#reg_age').val()) : undefined
      };
      $.ajax({ url: authBase + '/register', type: 'POST', data: JSON.stringify(payload), contentType: 'application/json' })
        .done(function(res) {
          const token = res && res.token;
          if (token) {
            setToken(token);
            $('#authMsg').text('Registered and logged in.');
            setAuthedUI(true);
            refreshMe();
            fetchUsers();
          }
        })
        .fail(function(err) {
          $('#authMsg').text('Registration failed.');
        });
    });

    // Login
    $('#loginForm').on('submit', function(e) {
      e.preventDefault();
      const payload = {
        email: $('#login_email').val(),
        password: $('#login_password').val()
      };
      $.ajax({ url: authBase + '/login', type: 'POST', data: JSON.stringify(payload), contentType: 'application/json' })
        .done(function(res) {
          const token = res && res.token;
          if (token) {
            setToken(token);
            $('#authMsg').text('Logged in.');
            setAuthedUI(true);
            refreshMe();
            fetchUsers();
          }
        })
        .fail(function(err) {
          $('#authMsg').text('Login failed.');
        });
    });

    // Logout
    $('#logoutBtn').on('click', function() {
      clearToken();
      $('#me').text('');
      $('#authMsg').text('Logged out.');
      setAuthedUI(false);
      renderUsers([]);
    });

    function refreshMe() {
      const headers = authHeaders();
      if (!headers.Authorization) { $('#me').text(''); return; }
      $.ajax({ url: authBase + '/me', headers })
        .done(function(res) {
          const user = (res && res.data) ? res.data : null;
          $('#me').text(user ? ('Logged in as: ' + user.name + ' (' + user.email + ')') : '');
        })
        .fail(function() { $('#me').text(''); });
    }

    // Init
    (function init() {
      const isAuthed = !!getToken();
      setAuthedUI(isAuthed);
      if (isAuthed) {
        refreshMe();
        fetchUsers();
      } else {
        $('#authMsg').text('Please login to manage users.');
      }
    })();
  </script>
</body>
</html>
