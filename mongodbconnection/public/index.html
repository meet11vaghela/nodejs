<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User CRUD</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f4f4f4; }
    button { margin: 2px; }
  </style>
</head>
<body>
  <h1>User CRUD</h1>

  <form id="userForm">
    <input type="hidden" id="userId">
    <input type="text" id="name" placeholder="Name" required>
    <input type="email" id="email" placeholder="Email" required>
    <input type="number" id="age" placeholder="Age">
    <button type="submit">Save</button>
  </form>

  <table>
    <thead>
      <tr><th>Name</th><th>Email</th><th>Age</th><th>Actions</th></tr>
    </thead>
    <tbody id="userTable"></tbody>
  </table>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    const apiBase = '/api/users';

    function renderUsers(users) {
      const rows = users.map(function(u) {
        const safeName = String(u.name || '').replace(/"/g, '&quot;');
        const safeEmail = String(u.email || '').replace(/"/g, '&quot;');
        const age = (u.age === undefined || u.age === null) ? '' : u.age;
        return (
          `\n        <tr>\n          <td>${safeName}</td>\n          <td>${safeEmail}</td>\n          <td>${age}</td>\n          <td>\n            <button onclick="editUser('${u._id}','${safeName}','${safeEmail}','${age}')">Edit</button>\n            <button onclick="deleteUser('${u._id}')">Delete</button>\n          </td>\n        </tr>`
        );
      }).join('');
      document.getElementById('userTable').innerHTML = rows;
    }

    function fetchUsers() {
      $.getJSON(apiBase)
        .done(function(res) {
          console.log('Fetched users', res);
          const users = Array.isArray(res) ? res : (res && res.data) ? res.data : [];
          renderUsers(users);
        })
        .fail(function(err) {
          console.error('Failed to fetch users', err);
          renderUsers([]);
        });
    }

    window.deleteUser = function(id) {
      $.ajax({ url: apiBase + '/' + id, type: 'DELETE' })
        .always(fetchUsers);
    };

    window.editUser = function(id, name, email, age) {
      $('#userId').val(id);
      $('#name').val(name);
      $('#email').val(email);
      $('#age').val(age);
    };

    $('#userForm').on('submit', function(e) {
      e.preventDefault();
      const id = $('#userId').val();
      const user = {
        name: $('#name').val(),
        email: $('#email').val(),
        age: $('#age').val() ? Number($('#age').val()) : undefined
      };

      const options = {
        url: id ? (apiBase + '/' + id) : apiBase,
        type: id ? 'PUT' : 'POST',
        data: JSON.stringify(user),
        contentType: 'application/json'
      };

      $.ajax(options)
        .always(function() {
          (document.getElementById('userForm')).reset();
          $('#userId').val('');
          fetchUsers();
        });
    });

    $(fetchUsers);
  </script>
</body>
</html>
